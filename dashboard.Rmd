---
title: "NY NOAA Weather Data Analysis"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
---

```{r setup, include=FALSE}
library(flexdashboard)
library(plotly)
library(p8105.datasets)
library(knitr)
library(tidyverse)
data(ny_noaa)


ny_noaa <- ny_noaa |>
  mutate(
    across(c(prcp, snow, snwd, tmax, tmin), ~as.numeric(.))
  )

ny_noaa_clean <- ny_noaa |> 
mutate(
date = as.Date(date),
year = year(date),
month = month(date),

prcp_mm = ifelse(!is.na(prcp), prcp / 10, NA_real_), 
tmax_c = ifelse(!is.na(tmax), tmax / 10, NA_real_), 
tmin_c = ifelse(!is.na(tmin), tmin / 10, NA_real_),
tavg_c = ifelse(!is.na(tmax) & !is.na(tmin), (tmax/10 + tmin/10)/2, NA_real_)
) |> 
select(id, date, year, month, prcp_mm, snow, snwd, tmax_c, tmin_c, tavg_c) |> 
filter(year >= 2000 & year <= 2010)
  
# Identify stations with temperature coverage
station_coverage <- ny_noaa_clean |> 
summarise(
.by = c(id, year),
n_days = dplyr::n(),
n_tmax = sum(!is.na(tmax_c)),
n_tmin = sum(!is.na(tmin_c)),
n_prcp = sum(!is.na(prcp_mm))
) |> 
mutate(
has_temp = n_tmax >= 150 & n_tmin >= 150, # heuristic: ~>= 5 months
has_prcp = n_prcp >= 150
)

stations_temp_any <- station_coverage |> 
summarise(.by = id, has_temp_any = any(has_temp)) |> 
filter(has_temp_any) |>  pull(id)

stations_prcp_any <- station_coverage |> 
summarise(.by = id, has_prcp_any = any(has_prcp)) |> 
filter(has_prcp_any) |>  pull(id)


top_temp_station <- ny_noaa_clean |> 
  filter(!is.na(tmax_c) | !is.na(tmin_c)) |> 
  count(id, name = "n_temp_days", sort = TRUE) |> 
  slice(1) |> 
  pull(id)

top_prcp_station <- ny_noaa_clean |> 
  filter(!is.na(prcp_mm)) |> 
  count(id, name = "n_prcp_days", sort = TRUE) |> 
  slice(1) |> 
  pull(id)

year_min <- min(ny_noaa_clean$year, na.rm = TRUE)
year_max <- max(ny_noaa_clean$year, na.rm = TRUE)
```



Column {data-width=500}
-----------------------------------------------------------------------

### Chart A

```{r, echo=FALSE, message=FALSE, warning=FALSE }

df_temp_line <- ny_noaa_clean |> 
  filter(id == top_temp_station,
         year >= year_min, year <= year_max) |> 
  filter(!is.na(tavg_c) | !is.na(tmax_c) | !is.na(tmin_c)) |> 
  arrange(date)

p_line <- df_temp_line |> 
  plot_ly(x = ~date) |> 
  add_lines(y = ~tavg_c, name = "Tavg (°C)") |> 
  add_markers(y = ~tmax_c, name = "Tmax (°C)", alpha = 0.4,
              text = ~paste("Date:", date, "<br>Tmax:", round(tmax_c,1), "°C"),
              hoverinfo = "text") |> 
  add_markers(y = ~tmin_c, name = "Tmin (°C)", alpha = 0.4,
              text = ~paste("Date:", date, "<br>Tmin:", round(tmin_c,1), "°C"),
              hoverinfo = "text") |> 
  layout(
    title = paste0("Daily Temperature — Station ", top_temp_station),
    xaxis = list(title = "Date"),
    yaxis = list(title = "Temperature (°C)"),
    legend = list(orientation = "h")
  )

p_line

```

Column {data-width=500}
-----------------------------------------------------------------------

### Chart B

```{r, echo=FALSE, message=FALSE, warning=FALSE }

df_temp_box <- ny_noaa_clean |> 
  filter(id == top_temp_station,
         year >= year_min, year <= year_max) |> 
  filter(!is.na(tmax_c)) |> 
  mutate(month_lab = factor(month, levels = 1:12, labels = month.abb))

p_box_tmax <- df_temp_box |> 
  plot_ly(x = ~month_lab, y = ~tmax_c, type = "box", boxpoints = "outliers",
          name = "Tmax (°C)") |> 
  layout(
    title = paste0("Monthly Tmax Distribution — Station ", top_temp_station),
    xaxis = list(title = "Month"),
    yaxis = list(title = "Tmax (°C)")
  )

p_box_tmax

```

### Chart C

```{r, echo=FALSE, message=FALSE, warning=FALSE }

df_prcp_bar <- ny_noaa_clean |> 
  filter(id == top_prcp_station,
         year >= 2005, year <= 2010) |> 
  filter(!is.na(prcp_mm)) |> 
  group_by(year, month) |> 
  summarise(total_prcp_mm = sum(prcp_mm), .groups = "drop") |> 
  mutate(month_lab = factor(month, levels = 1:12, labels = month.abb))

p_bar_prcp <- df_prcp_bar |> 
  plot_ly(x = ~month_lab, y = ~total_prcp_mm, type = "bar",
          color = ~factor(year)) |> 
  layout(
    title = paste0("Monthly Total Precipitation — Station ", top_prcp_station),
    xaxis = list(title = "Month"),
    yaxis = list(title = "Total precip (mm)"),
    barmode = "group"
  )

p_bar_prcp

```

